# Makefile for database management
# æ•°æ®åº“ç®¡ç†çš„Makefileæ–‡ä»¶

# å˜é‡å®šä¹‰
DB_FILE = my_database.db
SCHEMA_FILE = create_tables.sql
# CSV_FILE = ./raw/filtered_high_school_bracket_image.csv
IMPORT_SCRIPT = import_data.py
IMPORT_EDGES_SCRIPT = import_edges.py
SIMULATE_SCRIPT = simulate_student_data.py

# é»˜è®¤ç›®æ ‡
.PHONY: all clean rebuild import simulate help

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ“š æ•°æ®åº“ç®¡ç†å‘½ä»¤:"
	@echo "  make clean       - ğŸ—‘ï¸  åˆ é™¤ç°æœ‰æ•°æ®åº“æ–‡ä»¶"
	@echo "  make rebuild     - ğŸ”„ é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼ˆåˆ é™¤+åˆ›å»ºè¡¨ç»“æ„ï¼‰"
	@echo "  make import      - ğŸ“¥ å¯¼å…¥æ¨¡æ‹Ÿæ¦‚ç‡ä¼¦æ•°æ®åˆ°æ•°æ®åº“"
	@echo "  make simulate    - ğŸ­ æ¨¡æ‹Ÿå­¦ç”Ÿå­¦ä¹ è¡Œä¸ºæ•°æ®"
	@echo "  make all         - ğŸš€ å®Œæ•´æµç¨‹ï¼ˆé‡å»º+å¯¼å…¥æ‰€æœ‰æ•°æ®ï¼‰"
	@echo "  make help        - â“ æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# åˆ é™¤æ•°æ®åº“æ–‡ä»¶
clean:
	@echo "ğŸ—‘ï¸ åˆ é™¤æ•°æ®åº“æ–‡ä»¶..."
	@if [ -f $(DB_FILE) ]; then \
		rm -f $(DB_FILE) && echo "âœ… æ•°æ®åº“æ–‡ä»¶å·²åˆ é™¤"; \
	else \
		echo "â„¹ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"; \
	fi

# é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼ˆåˆ é™¤æ—§çš„å¹¶åˆ›å»ºè¡¨ç»“æ„ï¼‰
rebuild: clean
	@echo "ğŸ”„ é‡æ–°åˆ›å»ºæ•°æ®åº“..."
	@if [ -f $(SCHEMA_FILE) ]; then \
		sqlite3 $(DB_FILE) < $(SCHEMA_FILE) && echo "âœ… æ•°æ®åº“è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ"; \
	else \
		echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°schemaæ–‡ä»¶ $(SCHEMA_FILE)"; \
		exit 1; \
	fi

# å¯¼å…¥æ¦‚ç‡ä¼¦æ•°æ®
import:
	@echo "ğŸ“¥ å¯¼å…¥æ¨¡æ‹Ÿæ¦‚ç‡ä¼¦æ•°æ®..."
	@if [ -f $(IMPORT_SCRIPT) ]; then \
		python3 $(IMPORT_SCRIPT) && echo "âœ… æ¦‚ç‡ä¼¦æ¨¡æ‹Ÿæ•°æ®å¯¼å…¥å®Œæˆ"; \
	else \
		echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å¯¼å…¥è„šæœ¬ $(IMPORT_SCRIPT)"; \
		exit 1; \
	fi

# æ¨¡æ‹Ÿå­¦ç”Ÿå­¦ä¹ è¡Œä¸ºæ•°æ®
simulate:
	@echo "ğŸ­ æ¨¡æ‹Ÿå­¦ç”Ÿå­¦ä¹ è¡Œä¸ºæ•°æ®..."
	@if [ -f $(SIMULATE_SCRIPT) ]; then \
		python3 $(SIMULATE_SCRIPT) && echo "âœ… å­¦ç”Ÿå­¦ä¹ è¡Œä¸ºæ•°æ®æ¨¡æ‹Ÿå®Œæˆ"; \
	else \
		echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ¨¡æ‹Ÿè„šæœ¬ $(SIMULATE_SCRIPT)"; \
		exit 1; \
	fi

# å®Œæ•´æµç¨‹ï¼šé‡å»ºæ•°æ®åº“å¹¶å¯¼å…¥æ‰€æœ‰æ•°æ®
all: rebuild import simulate
	@echo "ğŸ‰ æ•°æ®åº“é‡å»ºå’Œæ‰€æœ‰æ•°æ®å¯¼å…¥å…¨éƒ¨å®Œæˆï¼"

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
status:
	@echo "ğŸ“Š æ•°æ®åº“çŠ¶æ€æ£€æŸ¥:"
	@if [ -f $(DB_FILE) ]; then \
		echo "âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨: $(DB_FILE)"; \
		sqlite3 $(DB_FILE) ".tables" | while read table; do \
			count=$$(sqlite3 $(DB_FILE) "SELECT COUNT(*) FROM $$table;"); \
			echo "  ğŸ“‹ è¡¨ $$table: $$count æ¡è®°å½•"; \
		done; \
	else \
		echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨"; \
	fi